---
- name: Create service directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
  loop:
    - "{{ ovpn.work_dir }}"
    - "{{ ovpn.work_dir }}/profiles"

- name: Copy docker compose file
  ansible.builtin.copy:
    src: files/compose.yaml
    dest: "{{ ovpn.work_dir }}/compose.yaml"

- name: Start docker compose file
  ansible.builtin.command: docker compose up -d
  args:
    chdir: "{{ ovpn.work_dir }}"

- name: Generate openvpn configuration
  ansible.builtin.command: docker compose run --rm openvpn ovpn_genconfig -u udp://{{ inventory_hostname }}:{{ ovpn.port }}
  environment:
    OVPN_PORT: "{{ ovpn.port }}"
  args:
    chdir: "{{ ovpn.work_dir }}"
